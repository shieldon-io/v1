# Core APIs

- setCaptcha
- setChannel
- setClosure
- setComponent
- setDriver
- setExcludedUrls
- setFilter
- setFilters
- setProperty
- setProperties
- setMessenger
- setIp
- getCurrentUrl
- managedBy
- outputJsSnippet
- captchaResponse
- setView
- createDatabase
- ban
- unban
- limitSession
- run

The public APIs can be chaining yet `SetDriver` must be the first and `run` must be the last.

## Chainable

### setCaptcha

- *param* CaptchaInterface
- *since* 2.0.0
- *return* self

For deatiled usages, please see [Captcha](captcha/index.md) sestion.

```php
$shieldon->setCaptcha(new \Shieldon\Captcha\Recaptcha([
    'key' => '6LfkOaUUAAAAAH-AlTz3hRQ25SK8kZKb2hDRSwz9',
    'secret' => '6LfkOaUUAAAAAJddZ6k-1j4hZC1rOqYZ9gLm0WQh',
    'version' => 'v2',
    'lang' => 'en',
]));
```

### setChannel

- *param* string `$channel` Channel name.
- *return* self

```php
$shieldon->setChannel('web_project');

// Start new shieldon each day.
$shieldon->setChannel('web_project_' . date('Ymd'));
```

### setClosure

- *param* string `$key`
- *param* Closure `$closure`
- *since* 3.0.0
- *return* self

Set a closure function.

```php
$shieldon->setClosure('www_authenticate', function() use ($authHandler, $authenticateList) {
    $authHandler->set($authenticateList);
    $authHandler->check();
});
```

### setComponent

- *param* ComponentInterface
- *return* self

```php
$shieldon->setComponent(new \Shieldon\Component\Ip());
```

### setDriver

- *param* DriverProvider
- *return* self

```php
$dbLocation = APPPATH . 'cache/shieldon.sqlite3';
$pdoInstance = new \PDO('sqlite:' . $dbLocation);
$shieldon->setDriver(new \Shieldon\Driver\SqliteDriver($pdoInstance));
```

### setExcludedUrls

- *param* array `$urls`
- *since* 3.0.0
- *return* self

Set the URLs you want them to be excluded them from protection.

```php
$list = [
    '/example/1',
    '/wp-login.php',
];

$shieldon->setExcludedUrls($list);
```

### setFilter

- *param* string `$filterName` Name of a Shieldon filter.
- *param* bool `$value` true|false
- *since* 3.0.0
- *return* self

```php
$shieldon->setFilter('session', false);
$shieldon->setFilter('cookie', false);
$shieldon->setFilter('referer', true);
$shieldon->setFilter('frequency', false); 
```

### setFilters

- *param* array `$settings` Filter settings.
- *return* self

```php
$shieldon->setFilters([
    'session' => true,
    'cookie' => true,
    'referer' => true,
    'frequency' => true,
]);
```

Default settings:

| key | type | value | description |
| --- | --- | --- | --- |
| session | boolean | true | Check PHP session cookie. |
| cookie | boolean | **false** | Check cookie generated by JavaScript. |
| referer | boolean | true | Check `HTTP_REFERER` |
| frequency | boolean | true | Check `time_unit_quota` setting. |

The Cookie filter is false by default, because you have to output the JavaScript snippet to your web pages. The JavaScript snippet created by `outputJsSnippet` will generate cookie by JavaScript.

Check out `outputJsSnippet` for usage.

### setProperty

- *param* string `$key`
- *param* mixed `$value`
- *return* self

```php
$shieldon->setProperty('time_unit_quota', [
    's' => 4,
    'm' => 20, 
    'h' => 60, 
    'd' => 240
]);
```
Default settings:

| key | type | value |
| --- | --- | --- |
| time_unit_quota | array |  `['s' => 2, 'm' => 10, 'h' => 30, 'd' => 60]` |
| time_reset_limit | integer | 3600 |
| interval_check_referer | integer | 5 |
| interval_check_session | integer | 30 |
| limit_unusual_behavior | array | `['cookie' => 5, 'session' => 5, 'referer' => 10]` |
| cookie_name | string | "ssjd" |
| cookie_domain | string | " |
| cookie_value | string | "1" |

The explanation of settings you cand find [here](http://shieldon.io/en/docs/configuration.html).

### setProperties

- *param* array `$settings`
- *return* self

```
$shieldon->setProperties($settings);
```

### setIp

- *param* string `$ip`
- *return* self

```php
// Here is an example, cature real vistor IP from CloudFlare.
$realIp = $_SERVER['HTTP_CF_CONNECTING_IP'];

// If you use a CDN serive on your website, 
// make sure to cature the real vistor IP, overwise users will get banned.
$shieldon->setIp($realIp);
```

### setMessenger

- *param* MessengerInterface `$instance`
- *return* self

```php
$apiKey = '981441296:AAGCcgv_NETMdWQCBTaMOk_yoMfax5EV7YQ';
$channel = '@your_channel';

$telegramMessenger = new \Messenger\Telegram($apiKey, $channel);

$shieldon->setMessenger($telegramMessenger);
```

### setView

- *param* string `$html` HTML text string.
- *param* string `$type` The page type.
- *return* self

```php
$htmlText = '<html>...bala...{{captcha}} ...bala...</html>';
$this->setView($htmlText, 'stop');
```

*$type*

| type  | description |
| --- | --- | --- | --- |
| stop | The page displayed when user get temporaily banned. | 
| limit | The page displayed when user is reached the online session limit. |
| deny | The page displayed when user is in blacklist. | 

*Template tag*

- `{{captcha}}`: The CAPTCHA form for **stop** page. (required)
- `{{online_info}}`: The online session infomation for for **limit** page.
- `{{lineup_info}}`: The line-up number infomation for for **limit** page.

### createDatabase

- *param* bool `$option` true or false [default: true]
- *return* self

```php
$this->createDatabase(false);
```


### ban

- *param* string `$ip` Single IP address.
- *return* self

```php
$shieldon->ban('33.125.12.87');
```

### unban

- *param* string `$ip` Single IP address.
- *return* self

```php
$shieldon->unban('33.125.12.87');

```

### limitSession

- *param* integer `$amount` Maximum amount of online vistors.
- *param* integer `$period` Period. (Unit: second)
- *return* self

```php
$shieldon->limitSession(500, 300);
```

## Non-chainable

### getCurrentUrl

- *since* 3.0.0
- *return* string

Return current URL.
This method equals $_SERVER['REQUEST_URI']

```php
echo $shieldon->getCurrentUrl();
```

### managedBy

- *param* string `Type` managed|config|demo
- *return* void

Tell Shieldon what type the Shieldon is managed by.
This setting only influences the Firewall Panel.

```php
$list = [
    '/example/1',
    '/wp-login.php',
];

$shieldon->managedBy('demo');
```

### outputJsSnippet

- *return* string [The JavaScript string.]

Required if cookie filiter is enabled.

```php
// Output this variable in your page template.
$jsCode = $shieldon->outputJsSnippet();
```

### captchaResponse

- *return* boolean

true: Captcha is solved successfully, 
false overwise.

```php
$result = $this->captchaResponsse();
```

### run

- *return* integer

Reponse code:

| constant | value | reason |
| --- | --- | --- |
|RESPONSE_DENY | 0 | Banned permanently. |
|RESPONSE_ALLOW | 1 | Passed. |
|RESPONSE_TEMPORARILY_DENY | 2 | Banned temporarily. |
|RESPONSE_LIMIT | 3 | Stopped due to reaching online session limit. |
 
```php
$result = $shieldon->run();
```